API接口安全整体解决方案如下：  
  1. Token授权认证，防止未授权用户获取数据。
  2. 时间戳超时机制，防重放，防止接口被第二次请求，防采集。
  3. URL签名，防止请求参数被篡改。
  4. 采用HTTPS通信协议，防止数据明文传输。
  5.  对数据进行合法性校验。
  6.  接口的要求规范。
  7.   常见场景的安全示例。  

## 一、Token授权认证
　　HTTP请求是无状态的，一次请求结束，连接断开，下次服务器再接收到请求，它就不知道这个请求是哪个用户发过来的，但是对我们有访问权限限制的模块而言，它是需要有状态管理的，以便服务端能够准确的知道HTTP请求是哪个用户发起的，从而判断他是否有权限继续这个请求。  
  
　　Token的设计方案是用户在客户端通过用户名和密码登录后，服务器会给客户端返回一个Token，后续客户端对需要授权的模块的所有的操作都需要带上这个Token，服务器端接收到请求后进行Token验证，如果Token验证通过，说明是授权的请求。  

　　Token生成应遵守的规范：  
　　　　1. **长度不低于16位，应用内要唯一**，否则会出现授权混乱，A用户看到了B用户的数据。  
　　　　2. **禁止使用固定的Token持续请求**，防止被记录，防止授权永久有效。  
　　　　3. 要设置Token的过期时间，过期后需要客户端重新登录，来获取新的Token。

## 二、时间戳超时机制
　　客户端每次请求接口时，应带上当前时间的时间戳（timestamp），服务端接收到时间戳后，与当前的时间戳进行比对，如果时间差大于限制的时间差（如：1分钟），则认为该请求已失效。

## 三、URL签名
　　将客户端发送给服务端的参数使用某种算法生成签名，请求服务端时带上此签名，然后服务端使用相同的算法进行签名校验，来判断参数在请求过程中是否被篡改过。
  
## 四、采用HTTPS通信协议
　　HTTP协议是以明文方式发送内容，不提供任何方式的数据加密，如果攻击者截取了客户端和服务器之前的传输报文，就可以直接读取其中的信息，因此HTTP协议不适合传输一些敏感信息，如银行卡号，密码、身份证号等。  
   
　　为了解决HTTP这一缺陷，需要使用另一种协议：超文本传输安全协议，即HTTPS协议。为了数据传输的安全，HTTPS在HTTP的基础上加入了SSL协议，SSL依靠证书来验证服务器的身份，并为客户端和服务端之间的通信进行加密。
  
## 五、数据合法性校验
  1. 不依赖客户端的数据校验，不管客户端有没有进行数据校验，服务端对所有接收到的数据都要做合法性校验。  
  2. 对用户输入的数据进行强制过滤，输出到前端时必须要进行转义，防止XSS攻击。  
  3. 禁止使用PUT和DELETE方式发送请求。

## 六、API要求规范  
  1. 做好API接口分析，所有API必须进行频率控制。  
  2. 所有Token、签名的加密、解密必须放在服务端。  
  3. 所有的接口必须记录访问日志，禁止在日志中记录用户的敏感信息（如：密码，身份证号等）。  
  4. 使用尽量复杂的算法进行加密。

## 七、常见场景的安全示例  
  1. 登录接口
      * 账号锁定：除提供外网访问功能的系统，必须启用账号登录失败锁定策略，防止恶意爆破（如：3分钟5次登录失败，账号&IP锁定半个小时），登录失败锁定策略应通过账号限制，不通过COOKIE等其他可控参数限制。  
      * 错误提示：用户名或密码错误时，返回的提示信息必须一致（如：用户名或密码错误）。  
      * 登录&注销：有登录功能的系统必须同时有注销或退出功能，注销退出后，后端需要同时使Token失效，避免用户退出后还可以继续使用系统。  
  2. 短信接口  
      * 严格限制手机号的格式（服务端）。  
      * 限制同一手机号的发送频率和数量，防止短信轰炸。  
      * 设置短信验证码的有效期，发送新的验证码后，旧验证码失效。  
      * **设置验证码失败策略，防止恶意爆破（如：3分钟内错误5次，手机号&IP锁定半个小时）**。  
  3. 图片验证码接口  
      * 使用工具不易识别的图片验证码。  
      * 验证码使用一次后，立刻失效，需要重新获取。  
      * **设置验证码的失败策略，防止恶意爆破（如：3分钟内错误5次，IP锁定半个小时）**。  
  4. 查询接口  
      * 必须使用参数化查询语句。  
      * **对用户输入的内容进行强制过滤，防止XSS攻击**。  
      * **查询结果列表不能直接显示用户信息（如姓名，手机号，身份证号等），服务端需要进行脱敏处理或不显示。如需获取用户详细信息，需要点击用户详情查看，并且将查询行为记录到日志中**。  
  5. 上传接口  
      * **服务端使用白名单机制对文件类型、文件大小等进行限制（如：图片只能上传2M以下的.jpg、.jpeg、.png）**。  
      * **文件存储到服务器时，文件名称必须随机化，禁止使用用户指定的文件名**。  
  6. 下载接口  
      * 净化数据：对用户传过来的文件名参数进行硬编码或同一编码；对文件类型进行白名单控制；拒绝包含恶意字符或者空字符的参数。  
      * 对下载文件地址进行正则匹配。  
      * 文件路径保存到数据库，让用户提交文件对应ID进行文件下载。  
      * **用户下载文件之前需要进行权限判断**。  
      * **文件要放在Web无法直接访问的目录下**。  
      * **禁止提供目录遍历服务**。  
      * **记录文件的下载日志**。
   
